The function appears to be well-structured with a focus on handling protocol-specific conditions and error cases.